
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>10 - 匹配法 &#8212; 因果推断：献给求真敢为者</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '10-Matching';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="11 - 倾向得分" href="11-Propensity-Score.html" />
    <link rel="prev" title="09 - 不依从性与局部平均处理效应" href="09-Non-Compliance-and-LATE.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">因果推断：献给求真敢为者</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    因果推断：献给求真敢为者
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">第一部分 - 阳</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01-Introduction-To-Causality.html">01 - 因果性导论</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-Randomised-Experiments.html">02 - 随机实验</a></li>
<li class="toctree-l1"><a class="reference internal" href="03-Stats-Review-The-Most-Dangerous-Equation.html">03 - 统计回顾：最危险的方程</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-Graphical-Causal-Models.html">04 - 图形因果模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="05-The-Unreasonable-Effectiveness-of-Linear-Regression.html">05 - 线性回归的惊人有效性</a></li>
<li class="toctree-l1"><a class="reference internal" href="06-Grouped-and-Dummy-Regression.html">06 - 分组与虚拟变量回归</a></li>
<li class="toctree-l1"><a class="reference internal" href="07-Beyond-Confounders.html">07 - 超越混杂因素</a></li>
<li class="toctree-l1"><a class="reference internal" href="08-Instrumental-Variables.html">08 - 工具变量</a></li>
<li class="toctree-l1"><a class="reference internal" href="09-Non-Compliance-and-LATE.html">09 - 不依从性与局部平均处理效应</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">10 - 匹配法</a></li>
<li class="toctree-l1"><a class="reference internal" href="11-Propensity-Score.html">11 - 倾向得分</a></li>
<li class="toctree-l1"><a class="reference internal" href="12-Doubly-Robust-Estimation.html">12 - 双重稳健估计</a></li>
<li class="toctree-l1"><a class="reference internal" href="13-Difference-in-Differences.html">13 - 双重差分法</a></li>
<li class="toctree-l1"><a class="reference internal" href="14-Panel-Data-and-Fixed-Effects.html">14 - 面板数据与固定效应</a></li>
<li class="toctree-l1"><a class="reference internal" href="15-Synthetic-Control.html">15 - 合成控制法</a></li>
<li class="toctree-l1"><a class="reference internal" href="16-Regression-Discontinuity-Design.html">16 - 断点回归设计</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2F10-Matching.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/10-Matching.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>10 - 匹配法</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">回归到底在做什么？</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">子类估计量</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">匹配估计量</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">匹配偏差</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">纬度灾难</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">核心要点</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">致谢</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">贡献</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>10 - 匹配法<a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<section id="id2">
<h2>回归到底在做什么？<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>正如我们目前所看到的，当我们进行处理组与对照组比较时，回归在控制额外变量方面表现得非常出色。若我们具备独立性 <span class="math notranslate nohighlight">\((Y_0, Y_1)\perp T | X\)</span>，那么回归能通过控制 X 来识别平均处理效应(ATE)。回归实现这一过程的方式近乎神奇。为获得直观理解，让我们回顾所有 X 变量均为虚拟变量的情形。此时，回归将数据划分至各虚拟单元，并计算处理组与对照组间的均值差异。由于是在固定的 X 虚拟单元内进行，这种均值差异能保持 X 恒定。这相当于执行 <span class="math notranslate nohighlight">\(E[Y|T=1] - E[Y|T=0] | X=x\)</span>，其中 <span class="math notranslate nohighlight">\(x\)</span> 代表一个虚拟单元（例如所有虚拟变量设为 1）。随后，回归通过加权整合各单元估计值以生成最终 ATE，其权重分配与各处理组内处理变量的方差成比例。</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">style</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.formula.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">smf</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">graphviz</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gr</span>

<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;fivethirtyeight&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>举个例子，假设我正在估计一种药物的效果，并且我有6名男性和4名女性。我的因变量是住院天数，我希望这款药物能缩短住院时间。对于男性，药物的真实因果效应是 -3，也就是说药物可以使他们的住院时间减少3天；而对女性，效应是 -2。</p>
<p>让情况更复杂一点，男性受这种疾病影响更严重，因此住院时间更长，并且他们更有可能接受这种药物——6个男性中只有1人没有服药。相对地，女性对这种疾病的抵抗力更强，住院时间也更短，且她们中有50%的人服用了药物。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">drug_example</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">sex</span><span class="o">=</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span><span class="s2">&quot;M&quot;</span><span class="p">,</span><span class="s2">&quot;M&quot;</span><span class="p">,</span><span class="s2">&quot;M&quot;</span><span class="p">,</span><span class="s2">&quot;M&quot;</span><span class="p">,</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span><span class="s2">&quot;W&quot;</span><span class="p">,</span><span class="s2">&quot;W&quot;</span><span class="p">,</span><span class="s2">&quot;W&quot;</span><span class="p">],</span>
    <span class="n">drug</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">days</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>注意，简单地比较处理组和对照组会得出一个带有负偏差的估计结果，也就是说，药物看起来没有它实际那么有效。这是可以预期的，因为我们遗漏了“性别”这个混杂变量。在这种情况下，估计的平均处理效应（ATE）小于真实值，因为男性更可能接受药物治疗，同时也更容易受到疾病的影响。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">drug_example</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;drug==1&quot;</span><span class="p">)[</span><span class="s2">&quot;days&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">drug_example</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;drug==0&quot;</span><span class="p">)[</span><span class="s2">&quot;days&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.1904761904761898
</pre></div>
</div>
</div>
</div>
<p>鉴于男性真实效应为-3 而女性为-2，平均处理效应（ATE）应为</p>
<p><span class="math notranslate nohighlight">\(
ATE=\dfrac{(-3*6) + (-2*4)}{10}=-2.6
\)</span></p>
<p>这个估计是通过以下三个步骤完成的：1）将数据按混杂变量划分为不同的单元，在这个例子中就是男性组和女性组；2）在每个单元内分别估计处理效应；3）将这些效应按加权平均进行组合，其中权重是每个单元或协变量组的样本量。如果我们的数据中男性和女性的数量完全相等，那么估计出的平均处理效应（ATE）就会正好是两组效应的中间值，也就是 -2.5。由于数据中男性多于女性，最终的ATE估计会更接近男性组的效应值。这种估计方法被称为非参数估计，因为它对数据的生成过程没有做出任何特定假设。</p>
<p>如果我们使用回归来控制性别变量，就等于在模型中加入了线性关系的假设。回归同样会将数据划分为男性和女性两个组，并分别估计它们各自的效应。这一切看起来都没问题。然而，在将各组效应合并时，回归并不是根据样本数量加权的。相反，回归使用的权重与各组中处理变量的方差成正比。在我们的例子中，由于只有一个男性属于对照组，男性组中处理变量的方差小于女性组。更具体地说，男性的处理变量 T 的方差为 <span class="math notranslate nohighlight">\(0.139=1/6*(1 - 1/6)\)</span> ，而女性的为 <span class="math notranslate nohighlight">\(0.25=2/4*(1 - 2/4)\)</span>。因此，在这个例子中，回归会对女性组给予更高的权重，最终估计的 ATE 会更接近女性的效应值 -2。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;days ~ drug + C(sex)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">drug_example</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
       <td></td>          <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>   <td>    7.5455</td> <td>    0.188</td> <td>   40.093</td> <td> 0.000</td> <td>    7.100</td> <td>    7.990</td>
</tr>
<tr>
  <th>C(sex)[T.W]</th> <td>   -3.3182</td> <td>    0.176</td> <td>  -18.849</td> <td> 0.000</td> <td>   -3.734</td> <td>   -2.902</td>
</tr>
<tr>
  <th>drug</th>        <td>   -2.4545</td> <td>    0.188</td> <td>  -13.042</td> <td> 0.000</td> <td>   -2.900</td> <td>   -2.010</td>
</tr>
</table></div></div>
</div>
<p>虚拟变量能更直观呈现该结果，但回归分析以其独特方式在估算效应时同样保持连续变量的恒定。对于连续变量，平均处理效应(ATE)也会向协变量方差更大的方向偏移。</p>
<p>由此我们了解到回归分析有其独特性。它是线性的、参数化的，偏好高方差特征……这既可能是优点也可能是缺点，取决于具体情境。正因如此，掌握其他控制混杂因素的技术至关重要。这些方法不仅是因果分析工具箱中的额外工具，理解处理混杂因素的不同方式更能拓宽我们对问题的认知。基于这一考量，现在我要向各位介绍<strong>子类估计量</strong>！</p>
</section>
<section id="id3">
<h2>子类估计量<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p><img alt="img" src="_images/explain.png" /></p>
<p>当我们需要估计某项因果效应（如职业培训对收入的影响）而处理变量并非随机分配时，必须警惕混杂因素。可能存在只有积极性更高的人群才会参加培训的情况，且无论是否参加培训这些人群原本就具有更高的收入水平。我们需要在动机水平及其他潜在混杂因素基本相似的小群体中，评估培训项目的真实效果。</p>
<p>更一般地说，如果我们想估计某种因果效应，但由于某些变量 X 的混杂而难以实现，我们需要做的是在 X 相同的小群体内进行处理组与对照组的比较。若我们具备条件独立性  <span class="math notranslate nohighlight">\((Y_0, Y_1)\perp T | X\)</span>，则可按下式表达平均处理效应（ATE）。</p>
<p><span class="math notranslate nohighlight">\(
ATE = \int(E[Y|X, T=1] - E[Y|X, T=0])dP(x)
\)</span></p>
<p>该积分的作用是遍历特征 X 分布的所有空间，计算所有这些微小空间内的均值差异，并将所有结果综合为平均处理效应。另一种理解方式是考虑一组离散特征。此时，我们可以说特征 X 分布在 K 个不同的单元 <span class="math notranslate nohighlight">\(\{X_1, X_2, ..., X_k\}\)</span> 中，我们所做的是计算每个单元内的处理效应，并将它们合并为 ATE。在此离散情形下，将积分转换为求和，即可推导出子类估计量。</p>
<p><span class="math notranslate nohighlight">\(
\hat{ATE} = \sum^K_{k=1}(\bar{Y}_{k1} - \bar{Y}_{k0}) * \dfrac{N_k}{N}
\)</span></p>
<p>其中横线代表处理组结果的平均值 <span class="math notranslate nohighlight">\(Y_{k1}\)</span>, 与非处理组 <span class="math notranslate nohighlight">\(Y_{k0}\)</span> 在第 k 个单元中的均值，<span class="math notranslate nohighlight">\(N_{k}\)</span> 表示该单元内的观测数量。可以看出，我们为每个单元计算局部平均处理效应（ATE），并通过加权平均进行合并，权重即为各单元的样本量。在上述医学案例中，该方法的首次估计值为−2.6。</p>
</section>
<section id="id4">
<h2>匹配估计量<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<p><img alt="img" src="_images/its-a-match.png" /></p>
<p>子类估计量在实际中应用较少（稍后将揭示原因——维度灾难问题），但它清晰展示了因果推断估计量应具备的功能：如何有效控制混杂变量。这为我们探索其他类型的估计量（如匹配估计量）提供了理论基础。</p>
<p>其核心理念高度相似。由于某些混杂变量 X 导致处理组与对照组初始不可比，可通过为<strong>每个处理单元匹配相似的对照单元实现可比性</strong>。这相当于为每个处理单元寻找未处理的”双胞胎”。通过这种配对比较，处理组与对照组重新获得可比性。</p>
<p>举例而言，假设我们正试图评估一项培训项目对收入的影响。以下是受训者的基本情况</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainee</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./data/trainees.csv&quot;</span><span class="p">)</span>
<span class="n">trainee</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;trainees==1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>unit</th>
      <th>trainees</th>
      <th>age</th>
      <th>earnings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>28</td>
      <td>17700</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>34</td>
      <td>10200</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>29</td>
      <td>14400</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>25</td>
      <td>20800</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>1</td>
      <td>29</td>
      <td>6100</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>1</td>
      <td>23</td>
      <td>28600</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>1</td>
      <td>33</td>
      <td>21900</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>1</td>
      <td>27</td>
      <td>28800</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9</td>
      <td>1</td>
      <td>31</td>
      <td>20300</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10</td>
      <td>1</td>
      <td>26</td>
      <td>28100</td>
    </tr>
    <tr>
      <th>10</th>
      <td>11</td>
      <td>1</td>
      <td>25</td>
      <td>9400</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12</td>
      <td>1</td>
      <td>27</td>
      <td>14300</td>
    </tr>
    <tr>
      <th>12</th>
      <td>13</td>
      <td>1</td>
      <td>29</td>
      <td>12500</td>
    </tr>
    <tr>
      <th>13</th>
      <td>14</td>
      <td>1</td>
      <td>24</td>
      <td>19700</td>
    </tr>
    <tr>
      <th>14</th>
      <td>15</td>
      <td>1</td>
      <td>25</td>
      <td>10100</td>
    </tr>
    <tr>
      <th>15</th>
      <td>16</td>
      <td>1</td>
      <td>43</td>
      <td>10700</td>
    </tr>
    <tr>
      <th>16</th>
      <td>17</td>
      <td>1</td>
      <td>28</td>
      <td>11500</td>
    </tr>
    <tr>
      <th>17</th>
      <td>18</td>
      <td>1</td>
      <td>27</td>
      <td>10700</td>
    </tr>
    <tr>
      <th>18</th>
      <td>19</td>
      <td>1</td>
      <td>28</td>
      <td>16300</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>以下是非培训人员：</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainee</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;trainees==0&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>unit</th>
      <th>trainees</th>
      <th>age</th>
      <th>earnings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>19</th>
      <td>20</td>
      <td>0</td>
      <td>43</td>
      <td>20900</td>
    </tr>
    <tr>
      <th>20</th>
      <td>21</td>
      <td>0</td>
      <td>50</td>
      <td>31000</td>
    </tr>
    <tr>
      <th>21</th>
      <td>22</td>
      <td>0</td>
      <td>30</td>
      <td>21000</td>
    </tr>
    <tr>
      <th>22</th>
      <td>23</td>
      <td>0</td>
      <td>27</td>
      <td>9300</td>
    </tr>
    <tr>
      <th>23</th>
      <td>24</td>
      <td>0</td>
      <td>54</td>
      <td>41100</td>
    </tr>
    <tr>
      <th>24</th>
      <td>25</td>
      <td>0</td>
      <td>48</td>
      <td>29800</td>
    </tr>
    <tr>
      <th>25</th>
      <td>26</td>
      <td>0</td>
      <td>39</td>
      <td>42000</td>
    </tr>
    <tr>
      <th>26</th>
      <td>27</td>
      <td>0</td>
      <td>28</td>
      <td>8800</td>
    </tr>
    <tr>
      <th>27</th>
      <td>28</td>
      <td>0</td>
      <td>24</td>
      <td>25500</td>
    </tr>
    <tr>
      <th>28</th>
      <td>29</td>
      <td>0</td>
      <td>33</td>
      <td>15500</td>
    </tr>
    <tr>
      <th>29</th>
      <td>31</td>
      <td>0</td>
      <td>26</td>
      <td>400</td>
    </tr>
    <tr>
      <th>30</th>
      <td>32</td>
      <td>0</td>
      <td>31</td>
      <td>26600</td>
    </tr>
    <tr>
      <th>31</th>
      <td>33</td>
      <td>0</td>
      <td>26</td>
      <td>16500</td>
    </tr>
    <tr>
      <th>32</th>
      <td>34</td>
      <td>0</td>
      <td>34</td>
      <td>24200</td>
    </tr>
    <tr>
      <th>33</th>
      <td>35</td>
      <td>0</td>
      <td>25</td>
      <td>23300</td>
    </tr>
    <tr>
      <th>34</th>
      <td>36</td>
      <td>0</td>
      <td>24</td>
      <td>9700</td>
    </tr>
    <tr>
      <th>35</th>
      <td>37</td>
      <td>0</td>
      <td>29</td>
      <td>6200</td>
    </tr>
    <tr>
      <th>36</th>
      <td>38</td>
      <td>0</td>
      <td>35</td>
      <td>30200</td>
    </tr>
    <tr>
      <th>37</th>
      <td>39</td>
      <td>0</td>
      <td>32</td>
      <td>17800</td>
    </tr>
    <tr>
      <th>38</th>
      <td>40</td>
      <td>0</td>
      <td>23</td>
      <td>9500</td>
    </tr>
    <tr>
      <th>39</th>
      <td>41</td>
      <td>0</td>
      <td>32</td>
      <td>25900</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>若进行简单的均值比较，我们会发现受训者的收入低于未参与该项目的人员。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainee</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;trainees==1&quot;</span><span class="p">)[</span><span class="s2">&quot;earnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">trainee</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;trainees==0&quot;</span><span class="p">)[</span><span class="s2">&quot;earnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-4297.49373433584
</pre></div>
</div>
</div>
</div>
<p>然而，观察上表可见，受训者年龄普遍小于非受训者，这表明年龄可能是一个混淆变量。为此，我们将采用年龄匹配法进行调整。具体操作如下：将处理组的第 1 单元与非处理组的第 27 单元配对（两者均为 28 岁），第 2 单元与第 34 单元配对，第 3 单元与第 37 单元配对，第 4 单元则与第 35 单元配对……当处理到第 5 单元时，需从非处理组中寻找同为 29 岁的匹配对象，但符合条件的第 37 单元已被使用。这并不构成问题，因为同一单元可重复使用。若存在多个匹配单元，则可随机选择其中之一进行配对。</p>
<p>这是前 7 个单元的匹配数据集样貌</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make dataset where no one has the same age</span>
<span class="n">unique_on_age</span> <span class="o">=</span> <span class="p">(</span><span class="n">trainee</span>
                 <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;trainees==0&quot;</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">))</span>

<span class="n">matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">trainee</span>
           <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;trainees==1&quot;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">unique_on_age</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_t_1&quot;</span><span class="p">,</span> <span class="s2">&quot;_t_0&quot;</span><span class="p">))</span>
           <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">t1_minuts_t0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;earnings_t_1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;earnings_t_0&quot;</span><span class="p">]))</span>

<span class="n">matches</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>unit_t_1</th>
      <th>trainees_t_1</th>
      <th>age</th>
      <th>earnings_t_1</th>
      <th>unit_t_0</th>
      <th>trainees_t_0</th>
      <th>earnings_t_0</th>
      <th>t1_minuts_t0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>28</td>
      <td>17700</td>
      <td>27</td>
      <td>0</td>
      <td>8800</td>
      <td>8900</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>34</td>
      <td>10200</td>
      <td>34</td>
      <td>0</td>
      <td>24200</td>
      <td>-14000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>29</td>
      <td>14400</td>
      <td>37</td>
      <td>0</td>
      <td>6200</td>
      <td>8200</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>25</td>
      <td>20800</td>
      <td>35</td>
      <td>0</td>
      <td>23300</td>
      <td>-2500</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>1</td>
      <td>29</td>
      <td>6100</td>
      <td>37</td>
      <td>0</td>
      <td>6200</td>
      <td>-100</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>1</td>
      <td>23</td>
      <td>28600</td>
      <td>40</td>
      <td>0</td>
      <td>9500</td>
      <td>19100</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>1</td>
      <td>33</td>
      <td>21900</td>
      <td>29</td>
      <td>0</td>
      <td>15500</td>
      <td>6400</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>注意最后一列显示的是处理组与其匹配的未处理组在收入上的差异。若取该列的平均值，我们便得到在控制年龄因素后的平均处理效应估计值（ATET）。与之前仅采用简单均值差的方法相比，可见此时的估计结果显著偏向正值。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matches</span><span class="p">[</span><span class="s2">&quot;t1_minuts_t0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2457.8947368421054
</pre></div>
</div>
</div>
</div>
<p>但这只是个刻意设计的示例，仅为引入匹配概念。现实中，我们通常面对多个特征且单元间无法完美匹配的情形。此时，需定义某种邻近度度量来比较单元间的相似程度。常用的度量之一是欧几里得范数 <span class="math notranslate nohighlight">\(||X_i - X_j||\)</span>。然而，该差异对特征尺度并不具有不变性。这意味着像年龄这样取值在十位数级别的特征，在计算范数时其重要性将远低于收入这类百位数量级的特征。因此，在应用范数前，需对特征进行缩放处理，使它们大致处于同一量级。</p>
<p>在定义了距离度量之后，我们现在可以将匹配定义为与待匹配样本最接近的邻居。用数学术语表达，匹配估计量可以写作如下形式</p>
<p><span class="math notranslate nohighlight">\(
\hat{ATE} = \frac{1}{N} \sum^N_{i=1} (2T_i - 1)\big(Y_i - Y_{jm}(i)\big)
\)</span></p>
<p>其中 <span class="math notranslate nohighlight">\(Y_{jm}(i)\)</span> 代表来自另一处理组中与 <span class="math notranslate nohighlight">\(Y_i\)</span> 最为相似的样本。我们进行 <span class="math notranslate nohighlight">\(2T_i - 1\)</span> 双向匹配：既将处理组与对照组匹配，也将对照组与处理组匹配。</p>
<p>为验证该估计量，我们以药物为例进行说明。再次强调，我们的目标是探究药物对康复天数的影响。然而，该效应受到病情严重程度、性别及年龄的混杂影响。我们有理由相信，病情更严重的患者接受药物治疗的概率更高。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">med</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./data/medicine_impact_recovery.csv&quot;</span><span class="p">)</span>
<span class="n">med</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sex</th>
      <th>age</th>
      <th>severity</th>
      <th>medication</th>
      <th>recovery</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>35.049134</td>
      <td>0.887658</td>
      <td>1</td>
      <td>31</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>41.580323</td>
      <td>0.899784</td>
      <td>1</td>
      <td>49</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>28.127491</td>
      <td>0.486349</td>
      <td>0</td>
      <td>38</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>36.375033</td>
      <td>0.323091</td>
      <td>0</td>
      <td>35</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>25.091717</td>
      <td>0.209006</td>
      <td>0</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>如果我们观察一个简单的均值差异 <span class="math notranslate nohighlight">\(E[Y|T=1]-E[Y|T=0]\)</span>，会发现接受治疗的患者平均比未治疗者多需要 16.9 天恢复。这很可能是由于混杂因素造成的，因为我们并不预期药物会对患者造成伤害。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">med</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;medication==1&quot;</span><span class="p">)[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">med</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;medication==0&quot;</span><span class="p">)[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16.895799546498726
</pre></div>
</div>
</div>
</div>
<p>为了纠正这种偏差，我们将通过匹配来控制变量 X。首先，需要记得对特征进行标准化处理，否则在计算点间距离时，像年龄这样的特征会比严重程度等特征具有更高权重。为此，我们可以对特征进行标准化。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># scale features</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;severity&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;recovery&quot;</span>

<span class="n">med</span> <span class="o">=</span> <span class="n">med</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="p">(</span><span class="n">med</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">-</span> <span class="n">med</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">/</span><span class="n">med</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">X</span><span class="p">})</span>
<span class="n">med</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sex</th>
      <th>age</th>
      <th>severity</th>
      <th>medication</th>
      <th>recovery</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.996980</td>
      <td>0.280787</td>
      <td>1.459800</td>
      <td>1</td>
      <td>31</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.002979</td>
      <td>0.865375</td>
      <td>1.502164</td>
      <td>1</td>
      <td>49</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.002979</td>
      <td>-0.338749</td>
      <td>0.057796</td>
      <td>0</td>
      <td>38</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.002979</td>
      <td>0.399465</td>
      <td>-0.512557</td>
      <td>0</td>
      <td>35</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.996980</td>
      <td>-0.610473</td>
      <td>-0.911125</td>
      <td>0</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>现在，进入匹配本身。我们不会编写匹配函数，而是使用 <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KNeighborsRegressor.html">Sklearn</a> 中的 K 最近邻算法。该算法通过寻找估计或训练集中最近的数据点来进行预测。</p>
<p>在匹配过程中，我们需要其中的两个。其一， <code class="docutils literal notranslate"><span class="pre">mt0</span></code> ，将存储未经处理的点，并在被要求时在未处理数据中寻找匹配项。另一个， <code class="docutils literal notranslate"><span class="pre">mt1</span></code> ，则存储经过处理的点，并在需要时在已处理数据中寻找匹配项。完成此拟合步骤后，我们可以利用这些 KNN 模型进行预测，这些预测即为我们的匹配结果。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsRegressor</span>

<span class="n">treated</span> <span class="o">=</span> <span class="n">med</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;medication==1&quot;</span><span class="p">)</span>
<span class="n">untreated</span> <span class="o">=</span> <span class="n">med</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;medication==0&quot;</span><span class="p">)</span>

<span class="n">mt0</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">untreated</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">untreated</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
<span class="n">mt1</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">treated</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="c1"># find matches for the treated looking at the untreated knn model</span>
    <span class="n">treated</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="n">mt0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">X</span><span class="p">])),</span>
    
    <span class="c1"># find matches for the untreated looking at the treated knn model</span>
    <span class="n">untreated</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="n">mt1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">untreated</span><span class="p">[</span><span class="n">X</span><span class="p">]))</span>
<span class="p">])</span>

<span class="n">predicted</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sex</th>
      <th>age</th>
      <th>severity</th>
      <th>medication</th>
      <th>recovery</th>
      <th>match</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.996980</td>
      <td>0.280787</td>
      <td>1.459800</td>
      <td>1</td>
      <td>31</td>
      <td>39.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.002979</td>
      <td>0.865375</td>
      <td>1.502164</td>
      <td>1</td>
      <td>49</td>
      <td>52.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>-0.996980</td>
      <td>1.495134</td>
      <td>1.268540</td>
      <td>1</td>
      <td>38</td>
      <td>46.0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1.002979</td>
      <td>-0.106534</td>
      <td>0.545911</td>
      <td>1</td>
      <td>34</td>
      <td>45.0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>-0.996980</td>
      <td>0.043034</td>
      <td>1.428732</td>
      <td>1</td>
      <td>30</td>
      <td>39.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>有了这些匹配项，我们现在可以应用匹配估计器公式</p>
<p><span class="math notranslate nohighlight">\(
\hat{ATE} = \frac{1}{N} \sum^N_{i=1} (2T_i - 1)\big(Y_i - Y_{jm}(i)\big)
\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">predicted</span><span class="p">[</span><span class="s2">&quot;medication&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">predicted</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted</span><span class="p">[</span><span class="s2">&quot;match&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.9954
</pre></div>
</div>
</div>
</div>
<p>通过这种匹配方式，我们可以看出药物的效果已不再积极。这意味着，在控制变量 X 的情况下，该药物平均能将康复时间缩短约 1 天。相较于原先存在偏差、预测康复时间会增加 16.9 天的估计，这已然是一个巨大的进步。</p>
<p>然而，我们还能做得更好。</p>
</section>
<section id="id5">
<h2>匹配偏差<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>我们发现，如上设计的匹配估计量实际上是有偏的。为了理解这一点，让我们考虑 ATET（处理组平均处理效应）估计量而非 ATE（平均处理效应），仅因其表达更为简洁。这一直觉同样适用于 ATE。</p>
<p><span class="math notranslate nohighlight">\(
\hat{ATET} = \frac{1}{N_1}\sum (Y_i - Y_j(i))
\)</span></p>
<p>其中 <span class="math notranslate nohighlight">\(N_1\)</span> 代表接受处理的个体数量，<span class="math notranslate nohighlight">\(Y_j(i)\)</span> 为处理单元 i 的未处理匹配项。为检验偏差，我们所做的是期望能够应用中心极限定理，使得下方内容收敛于均值为零的正态分布。</p>
<p><span class="math notranslate nohighlight">\(
\sqrt{N_1}(\hat{ATET} - ATET)
\)</span></p>
<p>然而，这并非总是发生。若我们定义给定 X 下未处理组的平均结果为 <span class="math notranslate nohighlight">\(\mu_0(x)=E[Y|X=x, T=0]\)</span>，则有（顺便提一下，此处我省略了证明过程，因其稍偏离主题）。</p>
<p><span class="math notranslate nohighlight">\(
E[\sqrt{N_1}(\hat{ATET} - ATET)] = E[\sqrt{N_1}(\mu_0(X_i) - \mu_0(X_j(i)))]
\)</span></p>
<p>现在，<span class="math notranslate nohighlight">\(\mu_0(X_i) - \mu_0(X_j(i))\)</span> 并不那么容易理解，因此我们需要更仔细地审视它。<span class="math notranslate nohighlight">\(\mu_0(X_i)\)</span> 是处理单元 <span class="math notranslate nohighlight">\(i\)</span> 若未接受处理时的结果 Y 值，即单元 i 的反事实结果  <span class="math notranslate nohighlight">\(Y_0\)</span>。<span class="math notranslate nohighlight">\(\mu_0(X_j(i))\)</span> 则是未处理单元 <span class="math notranslate nohighlight">\(j\)</span> ——即单元 <span class="math notranslate nohighlight">\(i\)</span> 的匹配对象——的结果。因此，它同样是 <span class="math notranslate nohighlight">\(Y_0\)</span> ，但这次针对的是单元 <span class="math notranslate nohighlight">\(j\)</span>。只不过这一次是实际结果，因为 <span class="math notranslate nohighlight">\(j\)</span> 属于未处理组。由于 <span class="math notranslate nohighlight">\(j\)</span> 与 <span class="math notranslate nohighlight">\(i\)</span> 仅是相似而非完全相同，这一差值很可能不为零。换言之，<span class="math notranslate nohighlight">\(X_i \approx X_j \)</span>。所以，<span class="math notranslate nohighlight">\(Y_{0i} \approx Y_{0j} \)</span>。</p>
<p>随着样本量的增加，可匹配的单元数量增多，单元 <span class="math notranslate nohighlight">\(i\)</span> 与其匹配单元 <span class="math notranslate nohighlight">\(j\)</span> 之间的差异也会缩小。但这种差异收敛至零的速度较慢。因此，<span class="math notranslate nohighlight">\(E[\sqrt{N_1}(\mu_0(X_i) - \mu_0(X_j(i)))]\)</span> 可能不会收敛至零，因为 <span class="math notranslate nohighlight">\(\sqrt{N_1}\)</span> 的增长速度快于 <span class="math notranslate nohighlight">\((\mu_0(X_i) - \mu_0(X_j(i)))\)</span> 的减小速度。</p>
<p>当匹配差异巨大时，偏差便会产生。幸运的是，我们知晓如何修正这一问题。每项观测数据对偏差的贡献为 <span class="math notranslate nohighlight">\((\mu_0(X_i) - \mu_0(X_j(i)))\)</span> ，因此只需在估计量中从每次匹配比较中减去这一数值即可。为此，我们可以用该数值 <span class="math notranslate nohighlight">\(\mu_0(X_j(i))\)</span> 的某种估计量（如通过线性回归等模型获得）来替代 <span class="math notranslate nohighlight">\(\hat{\mu_0}(X_j(i))\)</span>。这将 ATET 估计量更新为以下方程式</p>
<p><span class="math notranslate nohighlight">\(
\hat{ATET} = \frac{1}{N_1}\sum \big((Y_i - Y_{j(i)}) - (\hat{\mu_0}(X_i) - \hat{\mu_0}(X_{j(i)}))\big)
\)</span></p>
<p>其中 <span class="math notranslate nohighlight">\(\hat{\mu_0}(x)\)</span> 为 <span class="math notranslate nohighlight">\(E[Y|X, T=0]\)</span> 的某种估计值，例如仅基于未处理样本拟合的线性回归结果</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="c1"># fit the linear regression model to estimate mu_0(x)</span>
<span class="n">ols0</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">untreated</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">untreated</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>
<span class="n">ols1</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">treated</span><span class="p">[</span><span class="n">y</span><span class="p">])</span>

<span class="c1"># find the units that match to the treated</span>
<span class="n">treated_match_index</span> <span class="o">=</span> <span class="n">mt0</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># find the units that match to the untreatd</span>
<span class="n">untreated_match_index</span> <span class="o">=</span> <span class="n">mt1</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">untreated</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="p">(</span><span class="n">treated</span>
     <span class="c1"># find the Y match on the other group</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="n">mt0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">X</span><span class="p">]))</span> 
     
     <span class="c1"># build the bias correction term</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">bias_correct</span><span class="o">=</span><span class="n">ols0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">treated</span><span class="p">[</span><span class="n">X</span><span class="p">])</span> <span class="o">-</span> <span class="n">ols0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">untreated</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">treated_match_index</span><span class="p">][</span><span class="n">X</span><span class="p">]))),</span>
    <span class="p">(</span><span class="n">untreated</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="n">mt1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">untreated</span><span class="p">[</span><span class="n">X</span><span class="p">]))</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">bias_correct</span><span class="o">=</span><span class="n">ols1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">untreated</span><span class="p">[</span><span class="n">X</span><span class="p">])</span> <span class="o">-</span> <span class="n">ols1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">treated</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">untreated_match_index</span><span class="p">][</span><span class="n">X</span><span class="p">])))</span>
<span class="p">])</span>

<span class="n">predicted</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sex</th>
      <th>age</th>
      <th>severity</th>
      <th>medication</th>
      <th>recovery</th>
      <th>match</th>
      <th>bias_correct</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.996980</td>
      <td>0.280787</td>
      <td>1.459800</td>
      <td>1</td>
      <td>31</td>
      <td>39.0</td>
      <td>4.404034</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.002979</td>
      <td>0.865375</td>
      <td>1.502164</td>
      <td>1</td>
      <td>49</td>
      <td>52.0</td>
      <td>12.915348</td>
    </tr>
    <tr>
      <th>7</th>
      <td>-0.996980</td>
      <td>1.495134</td>
      <td>1.268540</td>
      <td>1</td>
      <td>38</td>
      <td>46.0</td>
      <td>1.871428</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1.002979</td>
      <td>-0.106534</td>
      <td>0.545911</td>
      <td>1</td>
      <td>34</td>
      <td>45.0</td>
      <td>-0.496970</td>
    </tr>
    <tr>
      <th>16</th>
      <td>-0.996980</td>
      <td>0.043034</td>
      <td>1.428732</td>
      <td>1</td>
      <td>30</td>
      <td>39.0</td>
      <td>2.610159</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>随即产生的一个直接问题是：这样做难道不会违背匹配的初衷吗？如果无论如何我都得运行线性回归，为何不直接使用它，而要采用这个复杂的模型。这是个合理的质疑，因此我需要花些时间来解答。</p>
<p><img alt="img" src="_images/ubiquitous-ols.png" /></p>
<p>首先，我们所拟合的线性回归并不通过外推处理维度来获取处理效应。相反，其目的仅在于校正偏差。此处的线性回归具有局部性，即它并不试图考察若处理组看起来像未处理组时会如何。它完全不进行此类外推。这部分工作留给了匹配环节。估计量的核心仍是匹配部分。我想在此强调的是，对于这一估计量而言，普通最小二乘法（OLS）处于次要地位。</p>
<p>第二点在于，匹配是一种非参数估计方法。它不假设线性或任何参数模型。因此，相较于线性回归，匹配更具灵活性，能在非线性特征极其显著而线性回归失效的场景中发挥作用。</p>
<p>这是否意味着你只应使用匹配法？嗯，这是个棘手的问题。阿尔贝托·阿巴迪主张确实应该如此，认为这种方法更为灵活，且一旦掌握了代码，操作起来同样简单。我对此并不完全信服。举例来说，阿巴迪投入了大量时间研究并开发这一估计方法（没错，他是推动匹配法发展至今日形态的科学家之一），显然他对这种方法有着个人情感上的投入。其次，线性回归的简洁性中有某些特质是匹配法所不具备的。“保持其他条件不变”的偏导数数学原理，在线性回归中比在匹配法中更易于理解。但这仅是我的个人偏好。老实说，这个问题并没有明确的答案。无论如何，回到我们的例子中来。</p>
<p>使用偏差校正公式后，我得到了如下的平均处理效应（ATE）估计值。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">predicted</span><span class="p">[</span><span class="s2">&quot;medication&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">predicted</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted</span><span class="p">[</span><span class="s2">&quot;match&quot;</span><span class="p">])</span><span class="o">-</span><span class="n">predicted</span><span class="p">[</span><span class="s2">&quot;bias_correct&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-7.362660906141391
</pre></div>
</div>
</div>
</div>
<p>当然，我们还需要围绕这一测量值设置置信区间，但数学理论就暂且讨论到这里。实际操作中，我们可以直接借用他人编写的代码，导入一个匹配估计器。比如，这是来自因果推断库 <a class="reference external" href="https://github.com/laurencium/causalinference">causalinference</a> 中的一个例子。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">causalinference</span><span class="w"> </span><span class="kn">import</span> <span class="n">CausalModel</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">CausalModel</span><span class="p">(</span>
    <span class="n">Y</span><span class="o">=</span><span class="n">med</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
    <span class="n">D</span><span class="o">=</span><span class="n">med</span><span class="p">[</span><span class="s2">&quot;medication&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
    <span class="n">X</span><span class="o">=</span><span class="n">med</span><span class="p">[[</span><span class="s2">&quot;severity&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>

<span class="n">cm</span><span class="o">.</span><span class="n">est_via_matching</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias_adj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">estimates</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Treatment Effect Estimates: Matching

                     Est.       S.e.          z      P&gt;|z|      [95% Conf. int.]
--------------------------------------------------------------------------------
           ATE     -7.709      0.609    -12.649      0.000     -8.903     -6.514
           ATC     -6.665      0.246    -27.047      0.000     -7.148     -6.182
           ATT     -9.679      1.693     -5.717      0.000    -12.997     -6.361
</pre></div>
</div>
</div>
</div>
<p>最终，我们可以有把握地说，我们的药物确实缩短了患者住院时间。由于 knn sklearn 实现与 causalinference Python 包在匹配平局处理上的差异，ATE 估计值略低于我的计算结果。</p>
<p>在结束这个话题之前，我想再稍微讨论一下匹配偏差的成因。我们发现当个体与其匹配对象相似度不足时，匹配会产生偏差。但究竟是什么导致它们如此不同？</p>
</section>
<section id="id6">
<h2>纬度灾难<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>事实证明，答案既简单又直观。基于少数特征（如性别）匹配个体很容易，但当我们增加年龄、收入、出生城市等更多特征时，寻找匹配对象就变得越来越困难。更概括地说，特征维度越高，个体与其匹配对象之间的距离就越大。</p>
<p>这不仅影响了匹配估计器的表现，还与之前提到的子类估计器密切相关。回顾早期那个关于药物效果在男女性别上差异的人为设计例子，构建子分类估计器相对简单，因为我们仅有两个类别：男性和女性。然而，若类别增多呢？假设我们有两个连续变量，如年龄和收入，并将它们各自离散化为 5 个区间，这将生成 25 个单元格，即 <span class="math notranslate nohighlight">\(5^2\)</span>。更进一步，如果有 10 个协变量，每个分 3 个区间，看似不多，对吧？但实际上，这将产生 59049 个单元格，即 <span class="math notranslate nohighlight">\(3^{10}\)</span>。显而易见，问题规模会迅速膨胀。这一现象在数据科学中普遍存在，被称为 <strong>“维度灾难”</strong> ！！！</p>
<p><img alt="img" src="_images/curse-of-dimensionality.png" />
图片来源： <a class="reference external" href="https://deepai.org/machine-learning-glossary-and-terms/curse-of-dimensionality">https://deepai.org/machine-learning-glossary-and-terms/curse-of-dimensionality</a></p>
<p>尽管这个名称听起来吓人且故作高深，但它实际上仅意味着填满特征空间所需的数据点数量会随着特征或维度的增加呈指数级增长。例如，若填满 3 个特征空间需要 X 个数据点，那么填满 4 个特征的空间则需要指数级更多的点。</p>
<p>在子类估计器的语境下，维度灾难意味着当特征数量庞大时，其性能将受到影响。大量特征意味着 X 中存在众多单元格。若单元格过多，部分单元格将仅有极少数据，甚至可能仅包含处理组或对照组，导致无法在该处估计平均处理效应（ATE），从而破坏估计器的有效性。在匹配情境中，这意味着特征空间将极为稀疏，单元间距离会非常遥远，这将增大匹配对之间的距离并引发偏差问题。</p>
<p>至于线性回归，它实际上能很好地处理这个问题。其做法是将所有特征 X 投影至单一的 Y 维度上，然后在该投影上进行处理组与对照组的比较。因此，从某种意义上说，线性回归通过某种降维方式来估计平均处理效应（ATE），这一方法相当精妙。</p>
<p>大多数因果模型也具备应对维度灾难的方法。虽然我不再赘述，但你在研究这些模型时应时刻牢记这一点。例如，在下一节讨论倾向得分时，不妨观察它是如何解决这一问题的。</p>
</section>
<section id="id7">
<h2>核心要点<a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
<p>本节伊始，我们理解了线性回归的功能及其如何助力识别因果关系。具体而言，我们认识到回归可视为将数据集划分为多个单元，计算每个单元内的 ATE，再将各单元的 ATE 整合为整个数据集的单一 ATE 值。</p>
<p>由此，我们推导出了一个基于子类的非常通用的因果推断估计量。虽然该估计量在实际应用中并不十分实用，但它为我们提供了关于如何解决因果推断估计问题的一些有趣见解。这进而引导我们探讨了匹配估计量的概念。</p>
<p>匹配法通过为每个处理单元寻找一个与之极为相似的非处理单元作为对照（反之亦然），从而控制混杂变量的影响。我们学习了如何利用 KNN 算法实现这一方法，以及如何通过回归校正其偏差。最后，我们比较了匹配法与线性回归的区别，认识到匹配作为一种非参数估计方法，不像线性回归那样依赖于线性假设。</p>
<p>最后，我们深入探讨了高维数据集带来的挑战，并分析了因果推断方法在此类数据中可能面临的困境。</p>
</section>
<section id="id8">
<h2>致谢<a class="headerlink" href="#id8" title="Link to this heading">#</a></h2>
<p>我愿将这一系列作品视为对 Joshua Angrist、Alberto Abadie 和 Christopher Walters 杰出计量经济学课程的致敬。第一部分的大部分思想源自他们在美国经济学会授课的内容。在艰难的 2020 年，正是观看他们的课程视频让我保持了理智。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.aeaweb.org/conference/cont-ed/2017-webcasts">Cross-Section Econometrics</a></p></li>
<li><p><a class="reference external" href="https://www.aeaweb.org/conference/cont-ed/2020-webcasts">Mastering Mostly Harmless Econometrics</a></p></li>
</ul>
<p>我还想引用 Angrist 的精彩著作。它们向我展示了计量经济学（他们称之为“Metrics”）不仅极为实用，而且充满乐趣。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.mostlyharmlesseconometrics.com">Mostly Harmless Econometrics</a></p></li>
<li><p><a class="reference external" href="https://www.masteringmetrics.com">Mastering ‘Metrics</a></p></li>
</ul>
<p>最后还要感谢 Miguel Hernán 和 Jamie Robins 的<a class="reference external" href="https://hsph.harvard.edu/profile/miguel-hernan/">《Causal Inference》</a>一书。它是我在面对最棘手的因果问题时的可靠伙伴。</p>
<p><img alt="img" src="_images/poetry.png" /></p>
</section>
<section id="id9">
<h2>贡献<a class="headerlink" href="#id9" title="Link to this heading">#</a></h2>
<p>《因果推断：献给求真敢为者》是一份关于因果推断的开源材料，属于科学统计领域。它仅基于 Python 使用免费软件，旨在实现经济与智力上的双重可及性。若您认为此书有价值并希望支持，请前往 <a class="reference external" href="https://www.patreon.com/causal_inference_for_the_brave_and_true">Patreon</a>。若暂无法经济支持，您也可以通过修正拼写错误、建议修改或对不理解的内容提供反馈来帮助改进。只需访问书籍仓库并提交问题。最后，若您喜欢此内容，请分享给可能受益的人，并在 GitHub 上为其加星。</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="09-Non-Compliance-and-LATE.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">09 - 不依从性与局部平均处理效应</p>
      </div>
    </a>
    <a class="right-next"
       href="11-Propensity-Score.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">11 - 倾向得分</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">回归到底在做什么？</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">子类估计量</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">匹配估计量</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">匹配偏差</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">纬度灾难</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">核心要点</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">致谢</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">贡献</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Matheus Facure
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>